<html><head><link rel="import" href="../../bower_components/polymer/polymer-element.html"><link rel="import" href="../data/data-transaction.html"><link rel="import" href="../redux-state.html"><script src="../data/webpack.min.js"></script><script src="../data/abi.js"></script></head><body><dom-module id="display-complete-request"><template><data-transaction id="transaction"></data-transaction></template><script>class MyCompleteRequest extends(new ReduxMixin(Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior],Polymer.Element))){static get is(){return"display-complete-request"}static get actions(){return Object.assign({ITEMTOIPFS:function(itemToIpfs){return{type:"ITEMTOIPFS",itemToIpfs:itemToIpfs}},SENDSIGNEDTX:function(sendSignedTx){return{type:"SENDSIGNEDTX",sendSignedTx:sendSignedTx}}})}static get properties(){return{privateKey:{type:String,observer:"_itemToIpfs"},path:{type:String,reflectToAttribute:!0,notify:!0},avatarHash:{type:Object,statePath:"avatarHash"},username:{type:Object,statePath:"username"},itemDescription:{type:Object,statePath:"itemDescription"},itemBudget:{type:String,statePath:"itemBudget"},itemDataHash:{type:Object,statePath:"itemDataHash",observer:"_newItemDataHash"},itemGeohash:{type:Object,statePath:"itemGeohash"},sendSignedTx:{type:Object},hashtag:{type:Object,statePath:"hashtag"},address:{type:String,statePath:"publicKey"},nonce:{type:Object,statePath:"nonce"}}}_itemToIpfs(){if(this.privateKey){let item={username:this.username,avatarHash:localStorage.getItem("avatarHash"),description:this.itemDescription};if(null!=this.itemGeohash){item.location=this.itemGeohash}this.dispatch("ITEMTOIPFS",JSON.stringify(item))}}_newItemDataHash(){if(200==this.itemDataHash.response){const UUIDv4=webpack.uuid.v4();let itemBudgetWei=1e18*this.itemBudget,itemHashBuffer=webpack.sha3(UUIDv4),itemHashHex=webpack.addHexPrefix(itemHashBuffer.toString("hex")),UUIDCollection=JSON.parse(localStorage.getItem("UUIDCollection"))||{};UUIDCollection[UUIDv4]=itemHashHex;localStorage.setItem("UUIDCollection",JSON.stringify(UUIDCollection));let simpleDealContract=new webpack.Contract(abi.hashtagSimpleDeal.abi,this.hashtag.address),rawNewItem=simpleDealContract.methods.newItem(itemHashHex,itemBudgetWei,this.itemDataHash.data).encodeABI(),totalSum=itemBudgetWei+this.hashtag.hashtagFee/2,swtContract=new webpack.Contract(abi.miniMeToken.abi,"0x0adbc89464cb7fa752adcf3533514949a2547589"),rawApproveAndCall=swtContract.methods.approveAndCall(this.hashtag.address,totalSum,rawNewItem).encodeABI();const txParams={nonce:this._toHex(this.nonce),gasPrice:1e9,gasLimit:3e6,to:"0x0adbc89464cb7fa752adcf3533514949a2547589",from:this.address,value:"0x00",data:rawApproveAndCall,chainId:42};this.$.transaction.signRawTx(txParams,this.privateKey).then(serializedTx=>{this.dispatch("SENDSIGNEDTX",serializedTx.toString("hex"))}).catch(err=>{this.error=err})}}_toHex(dec){let hex=(+dec).toString(16),result="000000".substr(0,6-hex.length)+hex;return"0x"+result}}window.customElements.define(MyCompleteRequest.is,MyCompleteRequest);</script></dom-module></body></html>